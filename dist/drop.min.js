let actions={expand:0,collapse:1,next:2,prev:3,hideList:4,keyboard:5};function getAllIndices(e,t){let s=[],i=-1;do -1!=(i=e.indexOf(t,i+1))&&s.push(i);while(-1!=i);return s}function filterOptions(e,t){let s=[];for(let i of(t=t.toLowerCase(),e)){let o=i.innerText.toLowerCase();String(o).includes(t)&&s.push(i)}return s}function key2Action(e,t,s){let i=e.key;if(!["ArrowDown","ArrowUp","Enter","Escape","Backspace","Clear"].includes(i)&&1!==i.length){if(!(i=e.currentTarget.value))return;i=i.slice(i.length-1)}if(!t&&["ArrowDown","ArrowUp","Enter"," "].includes(i))return actions.expand;if(t){if("ArrowUp"===i)return actions.prev;if("ArrowDown"===i)return actions.next;if("Escape"===i)return actions.collapse;else if(!s&&("Enter"===i||" "===i))return actions.hideList;else if(s&&"Enter"===i)return actions.hideList;else if(s&&("Backspace"===i||"Clear"===i||1===i.length))return actions.keyboard}}function getNewIndex(e,t,s){return(e=parseInt(e),t=parseInt(t),"number"!=typeof e||"number"!=typeof t)?(console.error("Index of active element could not be read as integer"),e):s===actions.next?Math.min(e+1,t):s===actions.prev?Math.max(e-1,0):e}function isVisible(e){let t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}function isScrollable(e){return e&&e.clientHeight<e.scrollHeight}function adjustScroll(e,t){e.offsetTop<t.scrollTop?t.scrollTo(0,e.offsetTop):e.offsetTop+e.offsetHeight>t.scrollTop+t.offsetHeight&&t.scrollTo(0,e.offsetTop-t.offsetHeight+e.offsetHeight)}export class Dropdown{#a=()=>null;#b;#c=[];#d=!0;#e={select:"Select all",deselect:"Deselect all",search:"Type to search",numSelect:"options selected"};state={};#f={};#g={};#h;get onStateUpdate(){return this.#a}get rootDOM(){return this.#b}get sections(){return this.#c}get state(){return this.state}get vertical(){return this.#d}get controlLabels(){return this.#e}set rootDOM(e){this.#b=e}set onStateUpdate(e){"function"==typeof e?this.#a=e:console.error("callback must be a function.")}set sections(e){let t=Array.isArray(e),s=!0;for(let i of e)s=s&&"object"==typeof i;t&&s?this.#c=e:console.error("list must be an array with 1+ object(s) as element(s)")}set vertical(e){"boolean"==typeof e?this.#d=e:console.error("inputBool must be a Boolean value")}set controlLabels(e){Array.isArray(e)&&4===e.length?this.#e={select:e[0],deselect:e[1],search:e[2],numSelect:e[3]}:console.error("controlLabels must be an array of four strings: alternative labels for the 'Select all' button, 'Deselect all' button, 'Type to search options' placeholder, and 'NUM options selected' placeholder.")}init(){this.#b.innerHTML="";let e=document.createElement("div");e.className="dpd-form",this.#d||e.classList.add("dpd-horizontal");for(let t=0;t<this.#c.length;t++){let s=this.#c[t];this.state[s.sectionID]={},this.#i(e,this.#c[t])}this.#b.appendChild(e),document.body.addEventListener("pointerup",this.#j.bind(this))}#i(e,t,s){let i=document.createElement("div");s&&(i=s),s||e.appendChild(i);let o=document.createElement("h4");i.classList.add("dpd-section"),0!=t.sectionOrder&&i.classList.add("dpd-hidden"),i.dataset.order=t.sectionOrder,i.dataset.name=t.sectionID,t.sectionTitle&&(o.innerText=t.sectionTitle,o.className="dpd-section-header",i.appendChild(o));let a=Math.max(...t.dropOrder)+1;for(let r=0;r<a;r++)this.#k(i,t,r)}#k(d,l,n,p){let c=getAllIndices(l.dropOrder,n);for(let h of(p&&(c=p.index),c)){let u=document.createElement("div");p?u=p.dom:d.appendChild(u);let b=l.sectionID,f=l.dropIDs[h];this.state[b][f]=[];let m=document.createElement("label");m.innerText=l.dropTitles[h],m.id=`${l.dropIDs[h]}-dpd-label`,m.className="dpd-label",m.setAttribute("for",`${l.dropIDs[h]}-dpd-combobox`),u.appendChild(m),u.className="dpd-section-group",u.dataset.order=l.dropOrder[h],u.dataset.name=l.dropIDs[h],l.disabled&&l.disabled[h]&&(u.disabled=!0,u.setAttribute("aria-disabled",!0)),this.#l(u,l,h),0!=n&&u.classList.add("dpd-hidden")}}#l(g,$,x){let _=$.dropIDs[x],y=$.sectionID,v=!0;$.dropInit&&"boolean"==typeof $.dropInit[x]&&(v=$.dropInit[x]);let A=document.createElement("div"),L=document.createElement("div"),S=document.createElement("div");g.appendChild(A),A.appendChild(L),A.appendChild(S),A.className="dpd-accessible-selector",$.dropMulti[x]&&(A.dataset.multi=!0),$.dropSearch[x]&&(A.dataset.search=!0),$.dropSearch[x]?this.#m(L,y,_,$,x):this.#n(L,y,_,$,x,v),S.setAttribute("class","dpd-listbox"),S.setAttribute("role","listbox"),S.setAttribute("id",`${_}-dpd-listbox`),S.setAttribute("aria-labelledby",`${_}-dpd-label`),S.setAttribute("tabindex",-1),S.onblur=()=>{A.dataset.multi&&this.#o(y,_,L,!1,!1)},this.#p(A,$.dropOptions[x],_,v)}#n(N,D,T,q,O,C=!0){N.id=`${T}-dpd-combobox`,N.className="dpd-combo",N.innerText=q.dropOptions[O][0],N.parentNode.dataset.multi&&C?N.innerText=`${q.dropOptions[O].length} ${this.controlLabels.numSelect}`:C||(N.innerText=`0 ${this.controlLabels.numSelect}`);let k=q.disabled&&q.disabled[O];this.#f[T]=!1,N.setAttribute("aria-expanded",!1),N.setAttribute("aria-controls",`${T}-dpd-listbox`),N.setAttribute("aria-haspopup","listbox"),N.setAttribute("aria-labelledby",`${T}-dpd-label`),N.setAttribute("role","combobox"),N.setAttribute("tabindex",k?-1:0),k&&(N.disabled=!0,N.setAttribute("aria-disabled","true")),k||(N.addEventListener("blur",this.#q.bind(this)),N.addEventListener("keyup",this.#r.bind(this)),N.addEventListener("click",()=>{this.#o(D,T,N,!this.open,!1)}))}#m(E,w,I,M,H){let U=document.createElement("input");U.id=`${I}-dpd-combobox`,U.className="dpd-combo",U.type="text",U.placeholder=this.#e.search;let P=M.disabled&&M.disabled[H];P&&(U.disabled=!0,U.setAttribute("aria-disabled",!0),U.setAttribute("tabIndex",-1),E.disabled=!0,E.setAttribute("aria-disabled",!0)),this.#f[I]=!1,U.setAttribute("aria-expanded",!1),U.setAttribute("aria-controls",`${I}-dpd-listbox`),U.setAttribute("aria-labelledby",`${I}-dpd-label`),U.setAttribute("role","combobox"),U.setAttribute("aria-autocomplete","list"),P||(U.addEventListener("blur",this.#q.bind(this)),U.addEventListener("keyup",this.#r.bind(this)),U.addEventListener("click",()=>{this.#o(w,I,U,!this.open,!1)}),U.addEventListener("focus",()=>{this.#o(w,I,U,!0,!1)})),E.className="dpd-search-group",E.appendChild(U)}#p(B,j,V,K=!0){let W=B.querySelector(".dpd-combo"),z=B.querySelector(".dpd-listbox"),G=B.parentNode.parentNode.dataset.name,R=B.dataset.multi,Y=!1;1===j.length&&(Y=!0),R&&(j=[this.#e.select,this.#e.deselect,...j]);for(let F=0;F<j.length;F++){let J=document.createElement("div");z.appendChild(J),J.innerText=j[F],J.dataset.name=j[F],J.id=`${V}-dpd-option-${F}`,J.classList.add("dpd-option");let Q=Y||!R&&0===F&&K||R&&K&&1!==F;R&&[0,1].includes(F)&&J.classList.add("dpd-option-select-all"),0===F&&J.classList.add("dpd-focused"),Q&&!(R&&[0,1].includes(F))&&this.state[G][V].push({id:F,val:J.innerText,new:!0}),J.setAttribute("aria-selected",Q),J.setAttribute("role","option"),J.onclick=e=>{let t=!!e.clientY;e.stopPropagation(),this.#s(F,V,W),this.#t(F,G,V,W),R?this.#o(G,V,W,t):this.#o(G,V,W,!1,!1)},J.onmousedown=()=>{this.#h=!0},Y&&setTimeout(()=>J.click(),1)}}modifySetting(e,t,s){let i=!1,o=!1,a;for(let r=0;r<this.#c.length;r++){let d=this.#c[r];if(d.sectionID==e)for(let l of(i=!0,a=d,Object.keys(d)))l==t&&(s&&(d[l]=s),o=!0)}if(i?!o&&s&&console.error(`section ${e} does not have key ${t}`):console.error(`section with ID: ${e} not found.`),i)return a}pushSection(e){let t=!0;("object"!=typeof e||Object.keys(e).length<1||"object"!=typeof this.#c)&&(t=!1),t?this.#c.push(e):console.error("Ensure inputData is an object with 1+ fields and that     #sections has been initialised")}resetSection(e,t){let s=this.#b.querySelector(".dpd-form");if(void 0===e&&void 0===t){s.remove(),this.state={},this.#f={},this.#g={},this.init();return}let i="string"==typeof e&&this.state[e],o=i&&"string"==typeof t&&this.state[e][t],a=this.#b.querySelector(`.dpd-section[data-name=${e}]`),r=Array.from(a.querySelectorAll(".dpd-section-group")),d=this.modifySetting(e);if(i&&!o){let l=r.map(e=>e.dataset.name);for(let n of(a.innerHTML="",this.state[e]={},l))this.#f[n]=void 0,this.#g[n]=void 0;this.#i(s,d,a);return}if(i&&o)for(let p of r){if(p.dataset.name!=t)continue;let c=d.dropIDs.indexOf(p.dataset.name);p.innerHTML="",this.state[e][t]=[],this.#f[t]=void 0,this.#g[t]=void 0,this.#k(a,d,0,{index:[c],dom:p})}}setActiveOption(e,t,s){let i=this.#b.querySelectorAll(`.dpd-section[data-name="${e}"] #${t}-dpd-listbox .dpd-option`),o=this.#b.querySelector(`.dpd-section[data-name="${e}"] #${t}-dpd-combobox`);s=s.map(e=>e.toLowerCase()),i.length&&(this.state[e][t]=[],this.state["dpd-updated"]=t);let a=()=>{if(!o.dataset.search){let s=0;i.forEach(e=>{"true"===e.getAttribute("aria-selected")&&(s+=1)}),1!=s&&(o.innerText=`${s} ${this.controlLabels.numSelect}`)}this.#o(e,t,o,!1,!1)};for(let r of i)s.includes(r.dataset.name.toLowerCase())?(r.click(),setTimeout(()=>{"true"!=r.getAttribute("aria-selected")&&(r.setAttribute("aria-selected",!0),r.classList.add("dpd-focused")),a(),this.#a(this.state)},50)):(r.setAttribute("aria-selected",!1),r.classList.remove("dpd-focused"));a()}#u(X,Z,ee,et){let es=!1;for(let ei=0;ei<this.state[X][Z].length;ei++){let eo=this.state[X][Z][ei];if(eo.id==ee){es=!0,this.state[X][Z].splice(ei,1);break}}es||this.state[X][Z].push(et)}#v(ea,er,ed,el){let en=Array.from(ea.querySelectorAll(".dpd-option"));for(let ep of en)ep.setAttribute("aria-selected",!1);for(let ec=0;ec<this.state[ed][el].length;ec++){let eh=this.state[ed][el][ec].id;en[eh].setAttribute("aria-selected",!0)}let eu="DIV"===er.tagName?"innerText":"placeholder",eb=1==this.state[ed][el].length?this.state[ed][el][0].val:`${this.state[ed][el].length} ${this.controlLabels.numSelect}`;er[eu]=eb,ea.dataset.search&&!ea.dataset.multi&&(er.value=""),"placeholder"===eu&&(this.#g[el]=er.value)}#s(ef,em,eg,e$){let ex=eg.parentNode;ex.classList.contains("dpd-search-group")&&(ex=ex.parentNode);let e_;e$?ef+=1:ef-=1;do if(e$?ef-=1:ef+=1,null===(e_=this.#b.querySelector(`#${em}-dpd-option-${ef}`)))return;while(e_.classList.contains("dpd-invisible"));eg.setAttribute("aria-activedescendant",e_.id);let ey=Array.from(ex.querySelectorAll(".dpd-option"));for(let ev of ey)ev.classList.remove("dpd-focused");e_.classList.add("dpd-focused");let eA=ex.querySelector(".dpd-listbox");isScrollable(eA)&&adjustScroll(ey[ef],eA),isVisible(ey[ef])||ey[ef].scrollIntoView({behavior:"smooth",block:"nearest"})}#t(eL,eS,eN,e9){let eD=e9.parentNode;eD.classList.contains("dpd-search-group")&&(eD=eD.parentNode);let eT=this.#b.querySelector(`#${eN}-dpd-option-${eL}`),eq={id:eL,val:eT.innerText};if(eD.dataset.multi){if(eT.classList.contains("dpd-option-select-all")){this.#w(eT,eD,e9,eS,eN);return}this.#u(eS,eN,eL,eq)}else this.state[eS][eN][0]=eq;this.#x(e9),this.#v(eD,e9,eS,eN)}#o(eO,eC,ek,eE,ew=!0){if(this.#f[eC]===eE)return;let eI=ek.parentNode;eI.classList.contains("dpd-search-group")&&(eI=eI.parentNode);let eM=this.state[eO][eC][0];eM&&(eM=eM.id),this.#f[eC]=eE,ek.setAttribute("aria-expanded",`${eE}`),eE?eI.classList.add("dpd-expanded"):eI.classList.remove("dpd-expanded");let eH=eE&&eM?`${eC}-dpd-option-${eM}`:"";ek.setAttribute("aria-activedescendant",eH),""!==eH||isVisible(ek)||ek.scrollIntoView({behavior:"smooth",block:"nearest"}),eE&&this.#y(eC,ek),ew&&ek.focus()}#q(eU){if(eU.relatedTarget){let eP=eU.relatedTarget,eB=eU.target.parentNode;if(eB.classList.contains("dpd-search-group")&&(eB=eB.parentNode),eB.contains(eP))return}if(this.#h){this.#h=!1;return}let[ej,eV]=this.#z(eU),e0=this.#f[eV];e0&&this.#o(ej,eV,eU.target,!1,!1)}#r(e2){let[eK,eW,e1,e3,ez,eG]=this.#z(e2,!0),eR=key2Action(e2,e3,ez),eY=getNewIndex(e1,eG,eR);eR===actions.prev||eR===actions.next?(e2.preventDefault(),this.#s(eY,eW,e2.target,eR===actions.prev)):eR===actions.hideList||eR===actions.collapse?(e2.preventDefault(),eR===actions.hideList&&this.#t(e1,eK,eW,e2.target),eR===actions.collapse&&this.#o(eK,eW,e2.target,!1)):eR===actions.keyboard?(this.#y(eW,e2.target),setTimeout(()=>{let e=e2.target.parentNode.parentNode.querySelector(".dpd-option:not(.dpd-invisible)");if(e){let[t,s,i,o]=e.id.split("-");this.#s(+o,t,e2.target,!1)}},100)):eR===actions.expand&&(e2.preventDefault(),this.#o(eK,eW,e2.target,!0))}#y(eF,eJ){setTimeout(()=>{this.#g[eF]=eJ.value;let e=eJ.parentNode.parentNode.querySelectorAll(".dpd-option");this.#A(eF,e)},10)}#j(eQ){for(let eX of Object.keys(this.#f)){if(!this.#f[eX])continue;let eZ=this.#b.querySelector(`#${eX}-dpd-combobox`),e4=this.#b.querySelector(`#${eX}-dpd-listbox`);e4.parentNode.contains(eQ.target)||setTimeout(()=>this.#q({target:eZ}),10)}}#w(e5,e6,e7,e8,te){this.state[e8][te]=[];let tt=Array.from(e6.querySelectorAll(".dpd-option:not(.dpd-invisible)"));for(let ts of tt){let ti=ts.id.split("-");if([0,1].includes(ti=parseInt(ti[ti.length-1])))continue;let to={id:ti,val:ts.innerText};e5.innerText===this.#e.select&&this.#u(e8,te,ti,to)}this.#v(e6,e7,e8,te);let ta=e6.querySelectorAll(".dpd-option-select-all");for(let tr of ta)tr.innerText===e5.innerText?tr.setAttribute("aria-selected",!0):tr.setAttribute("aria-selected",!1);this.#x(e7)}#z(td,tl=!1){let tn=td.target.id.split("-")[0],tp=td.target.parentNode.parentNode.parentNode;if(tp=tp.classList.contains("dpd-section-group")?tp.parentNode.dataset.name:tp.dataset.name,!tl)return[tp,tn];let tc,th;(tc=td.target.parentNode).classList.contains("dpd-search-group")?(th=tc.parentNode.querySelectorAll(".dpd-option").length-1,tc=tc.parentNode.querySelector(".dpd-option.dpd-focused")):(th=tc.querySelectorAll(".dpd-option").length-1,tc=tc.querySelector(".dpd-option.dpd-focused")),tc=!tc&&this.state[tp][tn][0]?this.state[tp][tn][0].id:tc?(tc=tc.id.split("-"))[tc.length-1]:0;let tu=this.#f[tn],tb="text"===td.target.type;return[tp,tn,tc,tu,tb,th]}#A(tf,tm){void 0===this.#g[tf]&&(this.#g[tf]="");let tg=filterOptions(tm,this.#g[tf]);for(let t$ of tm)tg.includes(t$)?t$.classList.remove("dpd-invisible"):t$.classList.contains("dpd-option-select-all")||t$.classList.add("dpd-invisible")}#x(tx){if("text"===tx.type&&(tx=tx.parentNode),!tx.parentNode||!tx.parentNode.parentNode)return;let t_=tx.parentNode.parentNode,ty=t_.parentNode,tv=ty.parentNode;this.state["dpd-updated"]=t_.dataset.name,this.#a(this.state);let tA=parseInt(t_.dataset.order),tL=ty.querySelectorAll(`div.dpd-section-group[data-order="${tA+1}"]`),tS=[];for(let tN=0;tN<tL.length;tN++)tL[tN].classList.contains("dpd-hidden")&&tS.push(tL[tN]);tA=parseInt(ty.dataset.order);let t9=!0,tD=tv.querySelectorAll(`div.dpd-section[data-order="${tA}"]`);for(let tT=0;tT<tD.length;tT++){let tq=!1,tO=tD[tT].dataset.name;tL=tD[tT].querySelectorAll("div.dpd-section-group");for(let tC=0;tC<tL.length;tC++){let tk=tL[tC].dataset.name,tE=this.state[tO][tk],tw=tE[0];if(tw&&(!tw.new||tE.length>1)){tq=!0;break}}t9=t9&&tq}if(t9){tD=tv.querySelectorAll(`div.dpd-section[data-order="${tA+1}"]`);for(let tI=0;tI<tD.length;tI++)tD[tI].classList.contains("dpd-hidden")&&tS.push(tD[tI])}for(let tM of tS)tM.classList.remove("dpd-hidden");for(let tH of tD=this.#b.querySelectorAll(".dpd-section")){if(tH.classList.contains("dpd-hidden"))continue;let tU=0;for(let tP of tH.children)tP.classList.contains("dpd-hidden")||(tU+=1);tH.style.flexGrow=tU}}}