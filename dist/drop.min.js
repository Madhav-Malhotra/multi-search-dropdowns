let actions={expand:0,collapse:1,next:2,prev:3,hideList:4,keyboard:5};function getAllIndices(e,t){let i=[],s=-1;do -1!=(s=e.indexOf(t,s+1))&&i.push(s);while(-1!=s);return i}function filterOptions(e,t){let i=[];for(let s of(t=t.toLowerCase(),e)){let o=s.innerText.toLowerCase();String(o).includes(t)&&i.push(s)}return i}function key2Action(e,t,i){if(!t&&["ArrowDown","ArrowUp","Enter"," "].includes(e))return actions.expand;if(t){if("ArrowUp"===e)return actions.prev;if("ArrowDown"===e)return actions.next;if("Escape"===e)return actions.collapse;else if(!i&&("Enter"===e||" "===e))return actions.hideList;else if(i&&"Enter"===e)return actions.hideList;else if(i&&("Backspace"===e||"Clear"===e||1===e.length))return actions.keyboard}}function getNewIndex(e,t,i){return(e=parseInt(e),t=parseInt(t),"number"!=typeof e||"number"!=typeof t)?(console.error("Index of active element could not be read as integer"),e):i===actions.next?Math.min(e+1,t):i===actions.prev?Math.max(e-1,0):e}function isVisible(e){let t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}function isScrollable(e){return e&&e.clientHeight<e.scrollHeight}function adjustScroll(e,t){e.offsetTop<t.scrollTop?t.scrollTo(0,e.offsetTop):e.offsetTop+e.offsetHeight>t.scrollTop+t.offsetHeight&&t.scrollTo(0,e.offsetTop-t.offsetHeight+e.offsetHeight)}export class Dropdown{#a=()=>null;#b;#c=[];#d=!0;state={};#e={};#f={};#g;get onStateUpdate(){return this.#a}get rootDOM(){return this.#b}get sections(){return this.#c}get state(){return this.state}get vertical(){return this.#d}set rootDOM(e){this.#b=e}set onStateUpdate(e){"function"==typeof e?this.#a=e:console.error("callback must be a function.")}set sections(e){let t=Array.isArray(e),i=!0;for(let s of e)i=i&&"object"==typeof s;t&&i?this.#c=e:console.error("list must be an array with 1+ object(s) as element(s)")}set vertical(e){"boolean"==typeof e?this.#d=e:console.error("inputBool must be a Boolean value")}init(){this.#b.innerHTML="";let e=document.createElement("div");e.className="dpd-form",this.#d||e.classList.add("dpd-horizontal");for(let t=0;t<this.#c.length;t++){let i=this.#c[t];this.state[i.sectionID]={},this.#h(e,this.#c[t])}this.#b.appendChild(e),document.body.addEventListener("pointerup",this.#i.bind(this))}#h(e,t,i){let s=document.createElement("div");i&&(s=i),i||e.appendChild(s);let o=document.createElement("h4");s.classList.add("dpd-section"),0!=t.sectionOrder&&s.classList.add("dpd-hidden"),s.dataset.order=t.sectionOrder,s.dataset.name=t.sectionID,t.sectionTitle&&(o.innerText=t.sectionTitle,o.className="dpd-section-header",s.appendChild(o));let a=Math.max(...t.dropOrder)+1;for(let d=0;d<a;d++)this.#j(s,t,d)}#j(n,r,l,p){let c=getAllIndices(r.dropOrder,l);for(let h of(p&&(c=p.index),c)){let u=document.createElement("div");p?u=p.dom:n.appendChild(u);let f=r.sectionID,b=r.dropIDs[h];this.state[f][b]=[];let m=document.createElement("label");m.innerText=r.dropTitles[h],m.id=`${r.dropIDs[h]}-dpd-label`,m.className="dpd-label",u.appendChild(m),u.className="dpd-section-group",u.dataset.order=r.dropOrder[h],u.dataset.name=r.dropIDs[h],this.#k(u,r,h),0!=l&&u.classList.add("dpd-hidden")}}#k(g,$,x){let y=$.dropIDs[x],_=$.sectionID,v=!0;$.dropInit&&"boolean"==typeof $.dropInit[x]&&(v=$.dropInit[x]);let A=document.createElement("div"),S=document.createElement("div"),L=document.createElement("div");g.appendChild(A),A.appendChild(S),A.appendChild(L),A.className="dpd-accessible-selector",$.dropMulti[x]&&(A.dataset.multi=!0),$.dropSearch[x]&&(A.dataset.search=!0),$.dropSearch[x]?this.#l(S,_,y,$,x):this.#m(S,_,y,$,x,v),L.setAttribute("class","dpd-listbox"),L.setAttribute("role","listbox"),L.setAttribute("id",`${y}-dpd-listbox`),L.setAttribute("aria-labelledby",`${y}-dpd-label`),L.setAttribute("tabindex",-1),L.onblur=e=>{A.dataset.multi&&this.#n(_,y,S,!1,!1)},this.#o(A,$.dropOptions[x],y,v)}#m(N,D,q,O,T,k=!0){N.id=`${q}-dpd-combobox`,N.className="dpd-combo",N.innerText=O.dropOptions[T][0],N.parentNode.dataset.multi&&k?N.innerText=`${O.dropOptions[T].length} options selected`:k||(N.innerText="0 options selected"),this.#e[q]=!1,N.setAttribute("aria-expanded",!1),N.setAttribute("aria-controls",`${q}-dpd-listbox`),N.setAttribute("aria-haspopup","listbox"),N.setAttribute("aria-labelledby",`${q}-dpd-label`),N.setAttribute("role","combobox"),N.setAttribute("tabindex",0),N.addEventListener("blur",this.#p.bind(this)),N.addEventListener("keydown",this.#q.bind(this)),N.addEventListener("click",()=>{this.#n(D,q,N,!this.open,!1)})}#l(C,w,E,I,M){let H=document.createElement("input");H.id=`${E}-dpd-combobox`,H.className="dpd-combo",H.type="text",H.placeholder="Type to search options",this.#e[E]=!1,H.setAttribute("aria-expanded",!1),H.setAttribute("aria-controls",`${E}-dpd-listbox`),H.setAttribute("aria-labelledby",`${E}-dpd-label`),H.setAttribute("role","combobox"),H.setAttribute("aria-autocomplete","list"),H.addEventListener("blur",this.#p.bind(this)),H.addEventListener("keydown",this.#q.bind(this)),H.addEventListener("click",()=>{this.#n(w,E,H,!this.open,!1)}),H.addEventListener("focus",()=>{this.#n(w,E,H,!0,!1)}),C.className="dpd-search-group",C.appendChild(H)}#o(P,U,B,j=!0){let V=P.querySelector(".dpd-combo"),K=P.querySelector(".dpd-listbox"),W=P.parentNode.parentNode.dataset.name,z=P.dataset.multi,G=!1;1===U.length&&(G=!0),z&&(U=["Select all","Unselect all",...U]);for(let R=0;R<U.length;R++){let Y=document.createElement("div");K.appendChild(Y),Y.innerText=U[R],Y.dataset.name=U[R],Y.id=`${B}-dpd-option-${R}`,Y.classList.add("dpd-option");let F=G||!z&&0===R&&j||z&&j&&1!==R;z&&[0,1].includes(R)&&Y.classList.add("dpd-option-select-all"),0===R&&Y.classList.add("dpd-focused"),F&&!(z&&[0,1].includes(R))&&this.state[W][B].push({id:R,val:Y.innerText,new:!0}),Y.setAttribute("aria-selected",F),Y.setAttribute("role","option"),Y.onclick=e=>{let t=!!e.clientY;e.stopPropagation(),this.#r(R,B,V),this.#s(R,W,B,V),z?this.#n(W,B,V,t):this.#n(W,B,V,!1,!1)},Y.onmousedown=()=>{this.#g=!0},G&&setTimeout(()=>Y.click(),1)}}modifySetting(e,t,i){let s=!1,o=!1,a;for(let d=0;d<this.#c.length;d++){let n=this.#c[d];if(n.sectionID==e)for(let r of(s=!0,a=n,Object.keys(n)))r==t&&(i&&(n[r]=i),o=!0)}if(s?!o&&i&&console.error(`section ${e} does not have key ${t}`):console.error(`section with ID: ${e} not found.`),s)return a}pushSection(e){let t=!0;("object"!=typeof e||Object.keys(e).length<1||"object"!=typeof this.#c)&&(t=!1),t?this.#c.push(e):console.error("Ensure inputData is an object with 1+ fields and that     #sections has been initialised")}resetSection(e,t){let i=this.#b.querySelector(".dpd-form");if(void 0===e&&void 0===t){i.remove(),this.state={},this.#e={},this.#f={},this.init();return}let s="string"==typeof e&&this.state[e],o=s&&"string"==typeof t&&this.state[e][t],a=this.#b.querySelector(`.dpd-section[data-name=${e}]`),d=Array.from(a.querySelectorAll(".dpd-section-group")),n=this.modifySetting(e);if(s&&!o){let r=d.map(e=>e.dataset.name);for(let l of(a.innerHTML="",this.state[e]={},r))this.#e[l]=void 0,this.#f[l]=void 0;this.#h(i,n,a);return}if(s&&o)for(let p of d){if(p.dataset.name!=t)continue;let c=n.dropIDs.indexOf(p.dataset.name);p.innerHTML="",this.state[e][t]=[],this.#e[t]=void 0,this.#f[t]=void 0,this.#j(a,n,0,{index:[c],dom:p})}}setActiveOption(e,t,i){let s=this.#b.querySelectorAll(`.dpd-section[data-name="${e}"] #${t}-dpd-listbox .dpd-option`),o=this.#b.querySelector(`.dpd-section[data-name="${e}"] #${t}-dpd-combobox`);s.length&&(this.state[e][t]=[],this.state["dpd-updated"]=t);let a=()=>{if(!o.dataset.search){let i=0;s.forEach(e=>{"true"===e.getAttribute("aria-selected")&&(i+=1)}),1!=i&&(o.innerText=`${i} options selected`)}this.#n(e,t,o,!1,!1)};for(let d of s)i.includes(d.dataset.name)?(d.click(),setTimeout(()=>{"true"!=d.getAttribute("aria-selected")&&(d.setAttribute("aria-selected",!0),d.classList.add("dpd-focused")),a(),this.#a(this.state)},50)):(d.setAttribute("aria-selected",!1),d.classList.remove("dpd-focused"));a()}#t(J,Q,X,Z){let ee=!1;for(let et=0;et<this.state[J][Q].length;et++){let ei=this.state[J][Q][et];if(ei.id==X){ee=!0,this.state[J][Q].splice(et,1);break}}ee||this.state[J][Q].push(Z)}#u(es,eo,ea,ed){let en=Array.from(es.querySelectorAll(".dpd-option"));for(let er of en)er.setAttribute("aria-selected",!1);for(let el=0;el<this.state[ea][ed].length;el++){let ep=this.state[ea][ed][el].id;en[ep].setAttribute("aria-selected",!0)}let ec="DIV"===eo.tagName?"innerText":"value",eh=es.dataset.multi&&es.dataset.search,eu=1==this.state[ea][ed].length?this.state[ea][ed][0].val:`${this.state[ea][ed].length} options selected`;eh?eo.placeholder=eu:eo[ec]=eu,"value"===ec&&(this.#f[ed]=eo[ec])}#r(ef,eb,em,eg){let e$=em.parentNode;e$.classList.contains("dpd-search-group")&&(e$=e$.parentNode);let ex;eg?ef+=1:ef-=1;do if(eg?ef-=1:ef+=1,null===(ex=this.#b.querySelector(`#${eb}-dpd-option-${ef}`)))return;while(ex.classList.contains("dpd-invisible"));em.setAttribute("aria-activedescendant",ex.id);let ey=Array.from(e$.querySelectorAll(".dpd-option"));for(let e_ of ey)e_.classList.remove("dpd-focused");ex.classList.add("dpd-focused");let ev=e$.querySelector(".dpd-listbox");isScrollable(ev)&&adjustScroll(ey[ef],ev),isVisible(ey[ef])||ey[ef].scrollIntoView({behavior:"smooth",block:"nearest"})}#s(eA,eS,eL,eN){let eD=eN.parentNode;eD.classList.contains("dpd-search-group")&&(eD=eD.parentNode);let eq=this.#b.querySelector(`#${eL}-dpd-option-${eA}`),eO={id:eA,val:eq.innerText};if(eD.dataset.multi){if(eq.classList.contains("dpd-option-select-all")){this.#v(eq,eD,eN,eS,eL);return}this.#t(eS,eL,eA,eO)}else this.state[eS][eL][0]=eO;this.#w(eN),this.#u(eD,eN,eS,eL)}#n(eT,e9,ek,eC,ew=!0){if(this.#e[e9]===eC)return;let eE=ek.parentNode;eE.classList.contains("dpd-search-group")&&(eE=eE.parentNode);let eI=this.state[eT][e9][0];eI&&(eI=eI.id),this.#e[e9]=eC,ek.setAttribute("aria-expanded",`${eC}`),eC?eE.classList.add("dpd-expanded"):eE.classList.remove("dpd-expanded");let eM=eC&&eI?`${e9}-dpd-option-${eI}`:"";ek.setAttribute("aria-activedescendant",eM),""!==eM||isVisible(ek)||ek.scrollIntoView({behavior:"smooth",block:"nearest"}),eC&&this.#x(e9,ek),ew&&ek.focus()}#p(eH){if(eH.relatedTarget){let eP=eH.relatedTarget,eU=eH.target.parentNode;if(eU.classList.contains("dpd-search-group")&&(eU=eU.parentNode),eU.contains(eP))return}if(this.#g){this.#g=!1;return}let[eB,ej]=this.#y(eH),eV=this.#e[ej];eV&&this.#n(eB,ej,eH.target,!1,!1)}#q(e0){let[eK,eW,e2,e3,ez,eG]=this.#y(e0,!0),eR=key2Action(e0.key,e3,ez),eY=getNewIndex(e2,eG,eR);eR===actions.prev||eR===actions.next?(e0.preventDefault(),this.#r(eY,eW,e0.target,eR===actions.prev)):eR===actions.hideList||eR===actions.collapse?(e0.preventDefault(),eR===actions.hideList&&this.#s(e2,eK,eW,e0.target),eR===actions.collapse&&this.#n(eK,eW,e0.target,!1)):eR===actions.keyboard?(this.#x(eW,e0.target),setTimeout(()=>{let e=e0.target.parentNode.parentNode.querySelector(".dpd-option:not(.dpd-invisible)");if(e){let[t,i,s,o]=e.id.split("-");this.#r(+o,t,e0.target,!1)}},100)):eR===actions.expand&&(e0.preventDefault(),this.#n(eK,eW,e0.target,!0))}#x(e1,eF){setTimeout(()=>{this.#f[e1]=eF.value;let e=eF.parentNode.parentNode.querySelectorAll(".dpd-option");this.#z(e1,e)},10)}#i(eJ){for(let eQ of Object.keys(this.#e)){if(!this.#e[eQ])continue;let eX=this.#b.querySelector(`#${eQ}-dpd-combobox`),eZ=this.#b.querySelector(`#${eQ}-dpd-listbox`);eZ.parentNode.contains(eJ.target)||setTimeout(()=>this.#p({target:eX}),10)}}#v(e4,e5,e6,e7,e8){this.state[e7][e8]=[];let te=Array.from(e5.querySelectorAll(".dpd-option:not(.dpd-invisible)"));for(let tt of te){let ti=tt.id.split("-");if([0,1].includes(ti=parseInt(ti[ti.length-1])))continue;let ts={id:ti,val:tt.innerText};"Select all"===e4.innerText&&this.#t(e7,e8,ti,ts)}this.#u(e5,e6,e7,e8);let to=e5.querySelectorAll(".dpd-option-select-all");for(let ta of to)ta.innerText===e4.innerText?ta.setAttribute("aria-selected",!0):ta.setAttribute("aria-selected",!1);this.#w(e6)}#y(td,tn=!1){let tr=td.target.id.split("-")[0],tl=td.target.parentNode.parentNode.parentNode;if(tl=tl.classList.contains("dpd-section-group")?tl.parentNode.dataset.name:tl.dataset.name,!tn)return[tl,tr];let tp,tc;(tp=td.target.parentNode).classList.contains("dpd-search-group")?(tc=tp.parentNode.querySelectorAll(".dpd-option").length-1,tp=tp.parentNode.querySelector(".dpd-option.dpd-focused")):(tc=tp.querySelectorAll(".dpd-option").length-1,tp=tp.querySelector(".dpd-option.dpd-focused")),tp=!tp&&this.state[tl][tr][0]?this.state[tl][tr][0].id:tp?(tp=tp.id.split("-"))[tp.length-1]:0;let th=this.#e[tr],tu="text"===td.target.type;return[tl,tr,tp,th,tu,tc]}#z(tf,tb){void 0===this.#f[tf]&&(this.#f[tf]="");let tm=filterOptions(tb,this.#f[tf]);for(let tg of tb)tm.includes(tg)?tg.classList.remove("dpd-invisible"):tg.classList.contains("dpd-option-select-all")||tg.classList.add("dpd-invisible")}#w(t$){if("text"===t$.type&&(t$=t$.parentNode),!t$.parentNode||!t$.parentNode.parentNode)return;let tx=t$.parentNode.parentNode,ty=tx.parentNode,t_=ty.parentNode;this.state["dpd-updated"]=tx.dataset.name,this.#a(this.state);let tv=parseInt(tx.dataset.order),tA=ty.querySelectorAll(`div.dpd-section-group[data-order="${tv+1}"]`),tS=[];for(let tL=0;tL<tA.length;tL++)tA[tL].classList.contains("dpd-hidden")&&tS.push(tA[tL]);tv=parseInt(ty.dataset.order);let tN=!0,tD=t_.querySelectorAll(`div.dpd-section[data-order="${tv}"]`);for(let tq=0;tq<tD.length;tq++){let tO=!1,tT=tD[tq].dataset.name;tA=tD[tq].querySelectorAll("div.dpd-section-group");for(let t9=0;t9<tA.length;t9++){let tk=tA[t9].dataset.name,tC=this.state[tT][tk],tw=tC[0];if(tw&&(!tw.new||tC.length>1)){tO=!0;break}}tN=tN&&tO}if(tN){tD=t_.querySelectorAll(`div.dpd-section[data-order="${tv+1}"]`);for(let tE=0;tE<tD.length;tE++)tD[tE].classList.contains("dpd-hidden")&&tS.push(tD[tE])}for(let tI of tS)tI.classList.remove("dpd-hidden");for(let tM of tD=this.#b.querySelectorAll(".dpd-section")){if(tM.classList.contains("dpd-hidden"))continue;let tH=0;for(let tP of tM.children)tP.classList.contains("dpd-hidden")||(tH+=1);tM.style.flexGrow=tH}}}